<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Concert Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div id="main-view">
            <header>
                <div class="header-content">
                    <div class="app-title">
                        <h1>CONCERT TRACKER</h1>
                        <p>By Thaiticketmajor.com</p>
                    </div>
                    
                    <div class="auth-container"> 
                        <a href="/add_artist" class="add-artist-btn">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô‡∏Ñ‡∏ô‡πÇ‡∏õ‡∏£‡∏î</a>
                        <div id="auth-section"></div> </div>
                    </div>
                  <div class="search-container">
                    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    <input type="text" id="search-box" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">
                </div>
            </header>



            <section id="favorite-artists-section">
                <div class="section-header">
                    <h2>‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô‡∏Ñ‡∏ô‡πÇ‡∏õ‡∏£‡∏î‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
                </div>
                <div id="favorite-artists-list" class="artists-grid">
                    {% if favorite_artists %}
                        {% for artist in favorite_artists %}
                            <div class="favorite-artist-card">
                                <button class="delete-artist-btn" data-artist-name="{{ artist.name }}">&times;</button>
                                <a href="#" class="artist-card-link" data-artist-name="{{ artist.name }}">
                                    <img src="{{ artist.image_url }}" alt="{{ artist.name }}">
                                </a>
                                <span>{{ artist.name }}</span>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô‡∏Ñ‡∏ô‡πÇ‡∏õ‡∏£‡∏î</p>
                    {% endif %}
                </div>
            </section>

            <main id="concert-list" class="concert-grid">
                </main>
        </div>

        <div id="artist-view" class="hidden">
            <div class="view-header">
                <button id="back-to-main-btn">&larr; ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
                <h2 id="artist-concerts-title"></h2>
            </div>
            <div id="artist-concerts-grid" class="concert-grid"></div>
        </div>
    </div>

    <div id="notification-modal" class="modal-backdrop hidden">
        <div class="modal-content"><p id="notification-message"></p></div>
    </div>

    <script>
        // --- RENDER FUNCTIONS ---
        function showNotification(message, isSuccess = true, duration = 3000) {
            const modal = document.getElementById('notification-modal');
            const messageEl = document.getElementById('notification-message');
            const modalContent = modal.querySelector('.modal-content');
            
            messageEl.textContent = message;
            modalContent.className = isSuccess ? 'modal-content success' : 'modal-content error';
            modal.classList.remove('hidden');
            
            setTimeout(() => modal.classList.add('hidden'), duration);
        }

        function formatDate(isoString) {
            if (!isoString) return 'Date not specified';
            const date = new Date(isoString);
            return date.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        function renderConcerts(concerts, containerId) {
            const concertContainer = document.getElementById(containerId);
            concertContainer.innerHTML = '';

            if (!concerts || concerts.length === 0) {
                if (containerId === 'artist-concerts-grid') {
                    concertContainer.innerHTML = `<p class="error-message">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ï‡∏Ç‡∏≠‡∏á‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô thaiticketmajor</p>`;
                } else {
                    concertContainer.innerHTML = `<p class="error-message">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ï‡∏à‡∏≤‡∏Å ThaiTicketMajor ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á</p>`;
                }
            } else { 
                if (concerts.length === 1) {
                    concertContainer.classList.add('single-item');
                } else {
                    concertContainer.classList.remove('single-item');
                }
                concerts.forEach(concert => {
                    // --- LOGIC: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î URL ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô (Dept & BIBI) ---
                    if (concert.artist && concert.artist.toLowerCase() === 'dept') {
                        const yoloFestUrl = 'https://www.thaiticketmajor.com/concert/yolo-fest.html';
                        concert.url = yoloFestUrl;
                        concert.booking_url = yoloFestUrl;
                    } 
                    
                    // +++ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö BIBI ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà +++
                    else if (concert.artist && concert.artist.toLowerCase() === 'bibi') {
                        const bibiConcertUrl = 'https://www.thaiticketmajor.com/concert/2025-bibi-1st-world-toureve-in-bangkok.html';
                        concert.url = bibiConcertUrl;
                        concert.booking_url = bibiConcertUrl;
                    }
                    // --- ‡∏à‡∏ö LOGIC: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î URL ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ---
                    
                    const card = document.createElement('div');

                    card.className = 'concert-card';

                    // Use single quotes for data-concert to handle potential double quotes in concert name

                    card.innerHTML = `

                        <div class="card-content">

                            ${concert.image_url ? `<img src="${concert.image_url}" alt="${concert.name}" class="concert-image">` : ''}

                            <h2 class="card-title">${concert.name}</h2>

                            <p class="card-artist">‡πÇ‡∏î‡∏¢ ${concert.artist}</p>

                            <p class="card-details">${concert.venue}</p>

                            <p class="card-date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${concert.date}</p>

                            <div class="card-actions">
                            <a 
                                href="${concert.booking_url && concert.booking_url.startsWith('http')
                                        ? concert.booking_url
                                        : `https://www.thaiticketmajor.com/concert/?keyword=${encodeURIComponent(concert.artist)}`}"
                                target="_blank"
                                class="ticket-button">
                                ‡∏ã‡∏∑‡πâ‡∏≠‡∏ö‡∏±‡∏ï‡∏£
                                </a>


                                                                <button class="calendar-button" data-concert='${JSON.stringify(concert)}'>üìÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</button>
                                                                <a href="${concert.url}" target="_blank" class="ticket-button">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</a> </div>
                        </div>`;

                    concertContainer.appendChild(card);

                });

            }
        }


        
        function renderAuthButtons(status) {
            const authSection = document.getElementById('auth-section');
            let buttonsHTML = '';
            // Google Button
            if (status.google_logged_in) {
                buttonsHTML += '<button class="auth-button google-button linked" disabled>‚úì ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google ‡πÅ‡∏•‡πâ‡∏ß</button>';
            } else {
                buttonsHTML += '<a href="/google-login" class="auth-button google-button">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google</a>';
            }
            authSection.innerHTML = buttonsHTML;
        }

        // --- VIEW MANAGEMENT ---
            async function showArtistConcertsView(artistName) {
                document.getElementById('main-view').classList.add('hidden');
                const artistView = document.getElementById('artist-view');
                artistView.classList.remove('hidden');
        
                document.getElementById('artist-concerts-title').textContent = `‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ï‡∏Ç‡∏≠‡∏á ${artistName}`;
                const grid = document.getElementById('artist-concerts-grid');
                grid.innerHTML = '<p class="error-message">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ï...</p>';
        
                // --- LOGIC: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dept ‡πÅ‡∏•‡∏∞ BIBI ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Artist View ---
                if (artistName.toLowerCase() === 'dept') {
                    const yoloFestUrl = 'https://www.thaiticketmajor.com/concert/yolo-fest.html';
                    const deptConcert = {
                        "id": "dept-yolo-fest",
                        "artist": "Dept",
                        "name": "YOLO FEST",
                        "venue": "Various Venues", // Placeholder
                        "date": "2025-10-21T12:00:00", // Placeholder, will be overridden by the renderConcerts logic
                        "url": yoloFestUrl,
                        "image_url": "https://www.thaiticketmajor.com/img_poster/prefix_1/0258/6258/yolo-fest-681aee1868d02-l.png", // Changed placeholder text
                        "booking_url": yoloFestUrl,
                        "description": "‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ï‡∏û‡∏¥‡πÄ‡∏®‡∏© YOLO FEST ‡∏Ç‡∏≠‡∏á Dept",
                        "price": "N/A"
                    };
                    renderConcerts([deptConcert], 'artist-concerts-grid');
                } 
                // +++ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö BIBI ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà +++
                else if (artistName.toLowerCase() === 'bibi') {
                    const bibiConcertUrl = 'https://www.thaiticketmajor.com/concert/2025-bibi-1st-world-toureve-in-bangkok.html';
                    const bibiConcert = {
                        "id": "bibi-world-tour",
                        "artist": "BIBI",
                        "name": "2025 BIBI 1st WORLD TOUR [EVE] IN BANGKOK",
                        "venue": "‡∏¢‡∏π‡πÇ‡∏≠‡∏ö‡∏µ ‡πÑ‡∏•‡∏ü‡πå, ‡πÄ‡∏≠‡πá‡∏°‡∏™‡πÄ‡∏ü‡∏µ‡∏¢‡∏£‡πå",
                        "date": "9 ‡∏™.‡∏Ñ. 2568", 
                        "url": bibiConcertUrl,
                        "image_url": "https://www.thaiticketmajor.com/img_poster/prefix_1/0292/6292/2025-bibi-1st-world-toureve-in-bangkok-6800b6ce59b8e-l.png", // ‡πÉ‡∏ä‡πâ URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏°‡∏≤‡πÑ‡∏î‡πâ
                        "booking_url": bibiConcertUrl,
                        "description": "N/A",
                        "price": "N/A"
                    };
                    renderConcerts([bibiConcert], 'artist-concerts-grid');
                }
                // --- ‡∏à‡∏ö LOGIC: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ---
                else {
                    try {
                        console.log('Fetching concerts for artist:', artistName);
                        const response = await fetch(`/api/artist-concerts?artist=${encodeURIComponent(artistName)}`);
                        const concerts = await response.json();
                        console.log('Received concerts:', concerts);
                        renderConcerts(concerts, 'artist-concerts-grid');
                    } catch (error) {
                        grid.innerHTML = '<p class="error-message">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>';
                        console.error('Fetch artist concerts error:', error);
                    }
                }
            }
        function showMainView() {
            document.getElementById('artist-view').classList.add('hidden');
            document.getElementById('main-view').classList.remove('hidden');
        }

        // --- FETCH & UPDATE LOGIC ---
        async function initialLoad() {
            try {
                // Check auth status first
                console.log('Checking auth status...');
                const authStatus = await fetch('/api/auth-status').then(res => res.json());
                console.log('Auth status:', authStatus);
                renderAuthButtons(authStatus);

                // Fetch the main list of concerts first
                const mainConcertList = document.getElementById('concert-list');
                mainConcertList.innerHTML = '<p class="loading-message">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î...</p>'; // Clear previous content and show loading
                console.log('Fetching concerts...');
                const concerts = await fetch('/api/concerts').then(res => res.json());
                console.log('Fetched concerts:', concerts);
                renderConcerts(concerts, 'concert-list');
                console.log('Concerts rendered.');

            } catch (e) {
                console.error("Initial load failed:", e);
                document.getElementById('concert-list').innerHTML = '<p class="error-message">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p>';
            }
        }

        // --- EVENT LISTENERS ---
        document.body.addEventListener('click', async function(event) {
            const target = event.target;
            const artistCard = target.closest('.artist-card-link');
            const deleteButton = target.closest('.delete-artist-btn');

            // Handle clicking on an artist card
            if (artistCard) {
                event.preventDefault();
                const artistName = artistCard.dataset.artistName;
                showArtistConcertsView(artistName);
            }

            // Handle clicking delete artist button
            if (deleteButton) {
                event.preventDefault();
                const artistName = deleteButton.dataset.artistName;
                if (confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö ${artistName}?`)) {
                    const response = await fetch('/api/artist/delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: artistName })
                    });
                    const result = await response.json();
                    if (response.ok) {
                        showNotification(`‡∏•‡∏ö ${artistName} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
                        // Remove the card from the DOM
                        deleteButton.closest('.favorite-artist-card').remove();
                    } else {
                        showNotification(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${result.error}`, false);
                    }
                }
            }

            // Handle clicking "Add to Calendar" button
            const calendarButton = target.closest('.calendar-button');
            if (calendarButton) {
                try {
                    const concertData = JSON.parse(calendarButton.dataset.concert);
                    const response = await fetch('/api/add-to-calendar', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(concertData)
                    });
                    const result = await response.json();
                    if (response.ok) {
                        showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏° Event ‡∏•‡∏á‡πÉ‡∏ô Google Calendar ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    } else {
                        // If needs login, redirect
                        if(response.status === 401){
                            showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Calendar ‡∏Å‡πà‡∏≠‡∏ô', false);
                        } else {
                            showNotification(`Error: ${result && result.error ? result.error : 'Unknown error'}`, false);
                        }
                    }
                } catch(e) {
                    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', false);
                }
            }
        });

        // Back button
        document.getElementById('back-to-main-btn').addEventListener('click', showMainView);
        
        // Search box listener
        const searchBox = document.getElementById('search-box');
        searchBox.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                const artistName = searchBox.value.trim();
                if (artistName) {
                    // Redirect to ThaiTicketMajor search page for the artist
                    window.open(`https://www.thaiticketmajor.com/concert/?keyword=${encodeURIComponent(artistName)}`, '_blank');
                    searchBox.value = ''; // Clear search box after search
                }
            }
        });
        
        // --- INITIAL LOAD ---
        document.addEventListener('DOMContentLoaded', function() {
            initialLoad();
        });
    </script>
</body>
</html>