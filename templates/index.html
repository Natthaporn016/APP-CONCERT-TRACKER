<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Concert Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <!-- Main View Container -->
        <div id="main-view">
            <header>
                <div class="header-content">
                    <div>
                        <h1>CONCERT TRACKER</h1>
                        <p>‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>
                    </div>
                    <div id="auth-section" class="auth-container">
                        <!-- Auth buttons are rendered here -->
                    </div>
                </div>
                 <!-- Search Box -->
                <div class="search-container">
                    <!-- +++ ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ +++ -->
                    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    <input type="text" id="search-box" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">
                </div>
            </header>

            <section id="top-artists-section" class="hidden">
                <h2>‡∏®‡∏¥‡∏•‡∏õ‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ü‡∏±‡∏á‡∏ö‡πà‡∏≠‡∏¢</h2>
                <div id="top-artists-list" class="artists-grid"></div>
            </section>

            <main id="concert-list" class="concert-grid">
                <!-- Main concert list loads here -->
            </main>
        </div>

        <!-- Artist Specific Concerts View (Initially Hidden) -->
        <div id="artist-view" class="hidden">
            <div class="view-header">
                <button id="back-to-main-btn">&larr; ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
                <h2 id="artist-concerts-title"></h2>
            </div>
            <div id="artist-concerts-grid" class="concert-grid"></div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notification-modal" class="modal-backdrop hidden">
        <div class="modal-content"><p id="notification-message"></p></div>
    </div>

    <script>
        // --- RENDER FUNCTIONS ---
        function showNotification(message, isSuccess = true, duration = 3000) {
            const modal = document.getElementById('notification-modal');
            const messageEl = document.getElementById('notification-message');
            const modalContent = modal.querySelector('.modal-content');
            
            messageEl.textContent = message;
            modalContent.className = isSuccess ? 'modal-content success' : 'modal-content error';
            modal.classList.remove('hidden');
            
            setTimeout(() => modal.classList.add('hidden'), duration);
        }

        function formatDate(isoString) {
            if (!isoString) return 'Date not specified';
            const date = new Date(isoString);
            return date.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        function renderConcerts(concerts, containerId) {
            const concertContainer = document.getElementById(containerId);
            concertContainer.innerHTML = '';

                        if (!concerts || concerts.length === 0) {

                            concertContainer.innerHTML = `<p class="error-message">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ï‡∏à‡∏≤‡∏Å ThaiTicketMajor ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á</p>`;

                            // Do NOT return here. Let the function continue, but the loop won't run.

                        } else { // Only iterate and render cards if there are concerts

                                                                                        concerts.forEach(concert => {

                                                                                            const card = document.createElement('div');

                                                                                            card.className = 'concert-card';

                                                                                            // Use single quotes for data-concert to handle potential double quotes in concert name

                                                                                            card.innerHTML = `

                                                                                                <div class="card-content">

                                                                                                    ${concert.image_url ? `<img src="${concert.image_url}" alt="${concert.name}" class="concert-image">` : ''}

                                                                                                    <h2 class="card-title">${concert.name}</h2>

                                                                                                    <p class="card-artist">‡πÇ‡∏î‡∏¢ ${concert.artist}</p>

                                                                                                    <p class="card-details">${concert.venue}</p>

                                                                                                    <p class="card-date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${concert.date}</p>

                                                                                                    <div class="card-actions">

                                                                                                        ${concert.booking_url ? `<a href="${concert.booking_url}" target="_blank" class="ticket-button">‡∏ã‡∏∑‡πâ‡∏≠‡∏ö‡∏±‡∏ï‡∏£</a>` : ''}

                                                                                                        <button class="calendar-button" data-concert='${JSON.stringify(concert)}'>üìÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</button>
                            <a href="${concert.url}" class="ticket-button">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</a>

                                                                                                    </div>

                                                                                                </div>`;

                                                                                            concertContainer.appendChild(card);

                                                                                        });

                        }
        }

        function renderTopArtists(artists) {
            const artistsList = document.getElementById('top-artists-list');
            document.getElementById('top-artists-section').classList.remove('hidden');
            artistsList.innerHTML = '';
            artists.forEach(artist => {
                // This div is now a button to trigger the view change
                artistsList.innerHTML += `
                    <div class="artist-card-link" data-artist-name="${artist.name}" title="‡∏î‡∏π‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ï‡∏Ç‡∏≠‡∏á ${artist.name}">
                        <div class="artist-card">
                            <img src="${artist.image_url}" alt="${artist.name}">
                            <h3>${artist.name}</h3>
                        </div>
                    </div>`;
            });
        }
        
        function renderAuthButtons(status) {
            const authSection = document.getElementById('auth-section');
            let buttonsHTML = '';
            // Spotify Button
            if (status.spotify_logged_in) {
                buttonsHTML += '<a href="/logout" class="auth-button spotify-button">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>';
            } else {
                buttonsHTML += '<a href="/login" class="auth-button spotify-button">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Spotify</a>';
            }

            // Google Button
            if (status.google_logged_in) {
                buttonsHTML += '<button class="auth-button google-button linked" disabled>‚úì ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google ‡πÅ‡∏•‡πâ‡∏ß</button>';
            } else {
                buttonsHTML += '<a href="/google-login" class="auth-button google-button">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google</a>';
            }
            authSection.innerHTML = buttonsHTML;
        }

        // --- VIEW MANAGEMENT ---
        async function showArtistConcertsView(artistName) {
            document.getElementById('main-view').classList.add('hidden');
            const artistView = document.getElementById('artist-view');
            artistView.classList.remove('hidden');

            document.getElementById('artist-concerts-title').textContent = `‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ï‡∏Ç‡∏≠‡∏á ${artistName}`;
            const grid = document.getElementById('artist-concerts-grid');
            grid.innerHTML = '<p class="error-message">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ï...</p>';

            try {
                const response = await fetch(`/api/artist-concerts?artist=${encodeURIComponent(artistName)}`);
                const concerts = await response.json();
                renderConcerts(concerts, 'artist-concerts-grid');
            } catch (error) {
                grid.innerHTML = '<p class="error-message">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>';
                console.error('Fetch artist concerts error:', error);
            }
        }

        function showMainView() {
            document.getElementById('artist-view').classList.add('hidden');
            document.getElementById('main-view').classList.remove('hidden');
        }

        // --- FETCH & UPDATE LOGIC ---
        async function initialLoad() {
            try {
                // Check auth status first
                const authStatus = await fetch('/api/auth-status').then(res => res.json());
                renderAuthButtons(authStatus);

                // Fetch the main list of concerts first
                const mainConcertList = document.getElementById('concert-list');
                mainConcertList.innerHTML = '<p class="loading-message">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î...</p>'; // Clear previous content and show loading
                const concerts = await fetch('/api/concerts').then(res => res.json());
                renderConcerts(concerts, 'concert-list');

                // If logged in to spotify, fetch top artists
                if (authStatus.spotify_logged_in) {
                    const artists = await fetch('/api/spotify/top-artists').then(res => res.json());
                    renderTopArtists(artists);
                }

            } catch (e) {
                console.error("Initial load failed:", e);
                document.getElementById('concert-list').innerHTML = '<p class="error-message">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p>';
            }
        }

        // --- EVENT LISTENERS ---
        document.body.addEventListener('click', async function(event) {
            const target = event.target;
            const artistCard = target.closest('.artist-card-link');

            // Handle clicking on an artist card
            if (artistCard) {
                const artistName = artistCard.dataset.artistName;
                if (artistName.toLowerCase() === 'dept') {
                    window.open('https://www.thaiticketmajor.com/concert/yolo-fest.html', '_blank');
                } else {
                    showArtistConcertsView(artistName);
                }
            }

            // Handle clicking "Add to Calendar" button
            const calendarButton = target.closest('.calendar-button');
            if (calendarButton) {
                try {
                    const concertData = JSON.parse(calendarButton.dataset.concert);
                    const response = await fetch('/api/add-to-calendar', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(concertData)
                    });
                    const result = await response.json();
                    if (response.ok) {
                        showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏° Event ‡∏•‡∏á‡πÉ‡∏ô Google Calendar ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    } else {
                        // If needs login, redirect
                        if(response.status === 401){
                            showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Calendar ‡∏Å‡πà‡∏≠‡∏ô', false);
                        } else {
                            showNotification(`Error: ${result.error}`, false);
                        }
                    }
                } catch(e) {
                     showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', false);
                }
            }
        });

        // Back button
        document.getElementById('back-to-main-btn').addEventListener('click', showMainView);
        
        // Search box listener
        const searchBox = document.getElementById('search-box');
        searchBox.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                const artistName = searchBox.value.trim();
                if (artistName) {
                    // Redirect to ThaiTicketMajor search page for the artist
                    window.open(`https://www.thaiticketmajor.com/concert/?keyword=${encodeURIComponent(artistName)}`, '_blank');
                    searchBox.value = ''; // Clear search box after search
                }
            }
        });
        
        // --- INITIAL LOAD ---
        document.addEventListener('DOMContentLoaded', initialLoad);
    </script>
</body>
</html>

